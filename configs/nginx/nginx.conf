worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile on;
    keepalive_timeout 65;

    server {
        listen 8080;

        location /hls/ {
            proxy_pass http://mediamtx:8888/;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
        }

        # Playlist gerada pelo edge-agent (HLS + links do YouTube)
        location = /playlist.m3u {
            proxy_pass http://edge-agent:9100/playlist.m3u;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
            default_type application/vnd.apple.mpegurl;
        }

        # Alias mais curto (muita gente tenta /playlist.m3)
        location = /playlist.m3 {
            proxy_pass http://edge-agent:9100/playlist.m3u;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
            default_type application/vnd.apple.mpegurl;
        }

        # Playlist JSON (metadata)
        location = /playlist.json {
            proxy_pass http://edge-agent:9100/playlist.json;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
            default_type application/json;
        }

        # Diagnóstico simples
        location = /health {
            return 200 'ok';
            add_header Content-Type text/plain;
            add_header Access-Control-Allow-Origin *;
        }

        # Página inicial (evita 404 confuso)
        location = / {
            return 200 '<html><body style="font-family:Arial;padding:20px"><h2>EDGE CDN</h2><p><a href="/playlist.m3u">playlist.m3u</a> • <a href="/playlist.m3">playlist.m3</a> • <a href="/hls/">/hls/</a> • <a href="/health">/health</a></p></body></html>';
            add_header Content-Type text/html;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
        }
    }
}
